#!/usr/bin/env bash

set -e

# Print out a classpath that includes guacamole and all of its transitive dependencies, for use by downstream scripts.
#
# First, check for an already-built assembly JAR; if one exists, print its path and exit.
#
# Otherwise, see if a Guacamole JAR (including shaded guava but no other dependencies) exists.
#
#   if so: pair it with either a "deps-only" JAR, if one exists, or a classpath built by the Maven dependency plugin
#          otherwise.
#   if not: fail.

# Go to the repo root.
cd "$(dirname "$(dirname "${BASH_SOURCE[@]}")")"

if source "scripts/.jars-rc"; then
  if [ -n "$uber_jar" ]; then
    echo "$uber_jar"
  else
    echo "$guac_jar:$deps_jar"
  fi
else
  guac_jar="$(scripts/guac-jar)"
  if [ -z "$guac_jar" ]; then
    exit 1
  fi

  tmp_cp_file="$(mktemp)"

  finish() {
    rm -f "$tmp_cp_file"
  }
  trap finish EXIT

  mvn dependency:build-classpath -Dmdep.outputFile="$tmp_cp_file" &> /dev/null
  echo "$guac_jar:$(cat "$tmp_cp_file")"
fi
